{% extends "base.html" %}
{% block title %}Room Mode Analysis - AcFella{% endblock %}
{% block content %}
<main class="container" style="padding-top:2rem;">
    <h1>Room Mode Analysis</h1>
    <p class="text-muted">Calculate standing waves, Schroeder frequency, Bonello criterion & optimal ratios.</p>

    <div class="calculator-layout">
        <div class="calc-inputs">
            <div class="result-card">
                <h3>Room Dimensions</h3>
                <form id="room-form" onsubmit="analyzeRoom(event)">
                    {% if project %}
                    <div class="project-badge">Project: {{ project.name }}</div>
                    {% endif %}
                    <div class="form-row">
                        <div class="form-group"><label>Length</label><input type="number" id="rm-length" step="0.01" value="{{ project.geometry.length if project and project.geometry else '4.20' }}" required></div>
                        <div class="form-group"><label>Width</label><input type="number" id="rm-width" step="0.01" value="{{ project.geometry.width if project and project.geometry else '2.83' }}" required></div>
                        <div class="form-group"><label>Height</label><input type="number" id="rm-height" step="0.01" value="{{ project.geometry.height if project and project.geometry else '2.41' }}" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit</label>
                            <select id="rm-unit"><option value="metric">Meters</option><option value="imperial">Feet</option></select>
                        </div>
                        <div class="form-group">
                            <label>Room Type</label>
                            <select id="rm-type">
                                <option value="mixing_mastering">Mixing/Mastering</option>
                                <option value="music_production">Music Production</option>
                                <option value="vocal_recording">Vocal Recording</option>
                                <option value="live_recording">Live Recording</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>RT60 (s)</label><input type="number" id="rm-rt60" step="0.01" value="0.3" min="0.1" max="3"></div>
                        <div class="form-group"><label>Max Freq (Hz)</label><input type="number" id="rm-maxfreq" value="500" min="100" max="1000"></div>
                    </div>
                    <div class="form-group">
                        <label>Show Mode Types</label>
                        <div class="checkbox-row">
                            <label><input type="checkbox" id="rm-axial" checked> Axial</label>
                            <label><input type="checkbox" id="rm-tangential" checked> Tangential</label>
                            <label><input type="checkbox" id="rm-oblique"> Oblique</label>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%">Analyze</button>
                </form>
                {% if projects %}
                <div class="form-group" style="margin-top:1rem;">
                    <label>Load from project:</label>
                    <select onchange="if(this.value)window.location='/room-analysis?project='+this.value">
                        <option value="">Select project...</option>
                        {% for p in projects %}<option value="{{p.id}}" {% if project and p.id == project.id %}selected{% endif %}>{{p.name}}</option>{% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="calc-results" id="rm-results" style="display:none;">
            <div class="results-grid">
                <div class="result-card"><h3>Room Info</h3><div id="rm-info" class="result-content"></div></div>
                <div class="result-card"><h3>Schroeder Analysis</h3><div id="rm-schroeder" class="result-content"></div></div>
                <div class="result-card"><h3>Room Ratios</h3><div id="rm-ratios" class="result-content"></div></div>
                <div class="result-card"><h3>Bonello Criterion</h3><div id="rm-bonello" class="result-content"></div></div>
            </div>
            <div class="result-card"><h3>Mode Distribution</h3><div style="height:350px;"><canvas id="rm-chart"></canvas></div></div>
            <div class="result-card"><h3>Mode List</h3><div id="rm-modelist" class="result-content" style="max-height:400px;overflow-y:auto;"></div></div>
            <div class="result-card"><h3>Problem Frequencies</h3><div id="rm-problems" class="result-content"></div></div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
let rmChart = null;
async function analyzeRoom(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = 'Analyzing...'; btn.disabled = true;

    const body = {
        length: parseFloat(document.getElementById('rm-length').value),
        width: parseFloat(document.getElementById('rm-width').value),
        height: parseFloat(document.getElementById('rm-height').value),
        unit: document.getElementById('rm-unit').value,
        room_type: document.getElementById('rm-type').value,
        rt60: parseFloat(document.getElementById('rm-rt60').value),
        max_frequency: parseFloat(document.getElementById('rm-maxfreq').value),
    };

    try {
        const resp = await fetch('/api/analyze-room', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const d = await resp.json();
        if (!d.success) { alert('Error: ' + d.error); return; }

        document.getElementById('rm-results').style.display = '';

        // Room info
        document.getElementById('rm-info').innerHTML = `
            <p><strong>Volume:</strong> ${d.room_info.volume} m&sup3;</p>
            <p><strong>Surface Area:</strong> ${d.room_info.surface_area} m&sup2;</p>
            <p><strong>Total Modes (up to ${body.max_frequency}Hz):</strong> ${d.modes.length}</p>
        `;

        // Schroeder
        document.getElementById('rm-schroeder').innerHTML = `
            <p><strong>Schroeder Frequency:</strong> <span class="value highlight">${d.schroeder.frequency} Hz</span></p>
            <p><strong>Transition Region:</strong> ${d.schroeder.transition_low} - ${d.schroeder.transition_high} Hz</p>
            <p><strong>Bass Trap Range:</strong> ${d.schroeder.bass_trap_range}</p>
            <p><strong>Absorber Range:</strong> ${d.schroeder.absorber_range}</p>
        `;

        // Ratios
        const r = d.ratios;
        let ratioHtml = `<p><strong>Current:</strong> ${r.current_ratios.join(' : ')}</p><p><strong>Best match:</strong> ${r.best_match} (deviation: ${r.best_deviation})</p>`;
        for (const [name, comp] of Object.entries(r.comparisons)) {
            ratioHtml += `<p>${name}: ${comp.optimal_ratios.join(':')} - <span class="${comp.match_quality === 'Excellent' || comp.match_quality === 'Good' ? 'good' : comp.match_quality === 'Fair' ? 'warning' : 'bad'}">${comp.match_quality}</span></p>`;
        }
        document.getElementById('rm-ratios').innerHTML = ratioHtml;

        // Bonello
        const b = d.bonello;
        document.getElementById('rm-bonello').innerHTML = `
            <p><strong>Result:</strong> <span class="${b.passes_bonello ? 'good' : 'bad'}">${b.passes_bonello ? 'PASSES' : 'FAILS'}</span></p>
            <p>${b.recommendation}</p>
        `;

        // Filter modes
        const showAxial = document.getElementById('rm-axial').checked;
        const showTang = document.getElementById('rm-tangential').checked;
        const showOblique = document.getElementById('rm-oblique').checked;
        const filtered = d.modes.filter(m =>
            (m.type === 'axial' && showAxial) ||
            (m.type === 'tangential' && showTang) ||
            (m.type === 'oblique' && showOblique)
        );

        // Chart
        if (rmChart) rmChart.destroy();
        const ctx = document.getElementById('rm-chart').getContext('2d');
        const colors = filtered.map(m => m.type === 'axial' ? '#ef4444' : m.type === 'tangential' ? '#f59e0b' : '#22c55e');
        rmChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: filtered.map(m => m.frequency + ' Hz'),
                datasets: [{
                    label: 'Room Modes',
                    data: filtered.map(m => m.frequency),
                    backgroundColor: colors,
                    borderRadius: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { afterLabel: ctx => { const m = filtered[ctx.dataIndex]; return `Type: ${m.type}\nMode: ${m.indices}`; }}}
                },
                scales: { y: { beginAtZero: true, title: {display:true, text:'Frequency (Hz)'} } }
            }
        });

        // Mode list table
        let tableHtml = '<table class="data-table"><tr><th>Freq (Hz)</th><th>Mode</th><th>Type</th><th>Wavelength (m)</th></tr>';
        for (const m of filtered.slice(0, 100)) {
            tableHtml += `<tr><td>${m.frequency}</td><td>${m.indices}</td><td><span class="mode-${m.type}">${m.type}</span></td><td>${m.wavelength}</td></tr>`;
        }
        tableHtml += '</table>';
        document.getElementById('rm-modelist').innerHTML = tableHtml;

        // Problems
        if (d.problems && d.problems.length) {
            document.getElementById('rm-problems').innerHTML = d.problems.map(p =>
                `<div class="problem-item severity-${p.severity}"><strong>${p.frequency.toFixed(1)} Hz</strong> - ${p.recommendation}</div>`
            ).join('');
        } else {
            document.getElementById('rm-problems').innerHTML = '<p class="good">No significant problems detected.</p>';
        }
    } catch(err) { console.error(err); alert('Error analyzing room'); }
    finally { btn.textContent = 'Analyze'; btn.disabled = false; }
}
</script>
{% endblock %}