{% extends "base.html" %}
{% block title %}{{ project.name }} - AcFella{% endblock %}
{% block content %}
<main class="container" style="padding-top:2rem;">
    <div class="breadcrumb"><a href="/projects">Projects</a> / {{ project.name }}</div>

    <div class="project-header">
        <div>
            <h1>{{ project.name }}</h1>
            <p class="text-muted">{{ project.description }}</p>
            <span class="badge">{{ project.room_type | replace('_', ' ') | title }}</span>
            {% for tag in project.tags %}<span class="tag">{{ tag }}</span>{% endfor %}
        </div>
        <div class="project-actions">
            <button class="btn-primary btn-sm" onclick="showEditModal()" style="margin-right:0.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px;">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit Room
            </button>
            <button class="btn-danger btn-sm" onclick="deleteProject('{{project.id}}')">Delete</button>
        </div>
    </div>

    {% if project.geometry %}
    <section class="section">
        <h2>Room Geometry</h2>
        <div class="results-grid">
            <div class="result-card">
                <h3>Dimensions</h3>
                <div class="result-content">
                    <p><strong>Length:</strong> {{ project.geometry.length }} m</p>
                    <p><strong>Width:</strong> {{ project.geometry.width }} m</p>
                    <p><strong>Height:</strong> {{ project.geometry.height }} m</p>
                    <p><strong>Volume:</strong> {{ project.geometry.volume }} m&sup3;</p>
                    {% if project.geometry.surface_area %}
                    <p><strong>Surface Area:</strong> {{ project.geometry.surface_area }} m&sup2;</p>
                    {% endif %}
                </div>
            </div>

            {% if project.geometry.left_wall_length %}
            <div class="result-card">
                <h3>Detailed Measurements</h3>
                <div class="result-content">
                    <p><strong>Left wall:</strong> {{ project.geometry.left_wall_length }} m (H: {{ project.geometry.ceiling_height_left }} m)</p>
                    <p><strong>Right wall:</strong> {{ project.geometry.right_wall_length }} m (H: {{ project.geometry.ceiling_height_right }} m)</p>
                    <p><strong>Front wall:</strong> {{ project.geometry.front_wall_width }} m</p>
                    <p><strong>Rear wall:</strong> {{ project.geometry.rear_wall_width }} m</p>
                </div>
            </div>
            {% endif %}

            {% if project.geometry.walls %}
            <div class="result-card">
                <h3>Wall Materials</h3>
                <div class="result-content">
                    {% for wall in project.geometry.walls %}
                    <div class="wall-info">
                        <strong>{{ wall.name }}:</strong>
                        {% for mat in wall.materials %}
                        <span class="tag">{{ mat.type | replace('_', ' ') | title }}</span>
                        {% if mat.notes %}<small class="text-muted"> ({{ mat.notes }})</small>{% endif %}
                        {% endfor %}
                        {% for opening in wall.openings %}
                        <span class="tag tag-warn">{{ opening.type | title }}: {{ opening.width_m }}m</span>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if project.geometry.beams %}
            <div class="result-card">
                <h3>Structural Elements</h3>
                <div class="result-content">
                    {% for beam in project.geometry.beams %}
                    <p><strong>Beam:</strong> {{ beam.width_m }}m wide, depth L: {{ beam.depth_left_m }}m / R: {{ beam.depth_right_m }}m</p>
                    <p>Height under beam: {{ beam.height_under_m }}m</p>
                    <p>{{ beam.distance_from_left_wall_m }}m from left, {{ beam.distance_from_right_wall_m }}m from right</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if project.geometry.ceilings %}
            <div class="result-card">
                <h3>Ceiling</h3>
                <div class="result-content">
                    {% for ceil in project.geometry.ceilings %}
                    <p><strong>{{ ceil.name }}:</strong> {{ ceil.material | replace('_', ' ') | title }} at {{ ceil.height }}m</p>
                    {% if ceil.notes %}<small class="text-muted">{{ ceil.notes }}</small>{% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="section">
        <h2>Analyze This Room</h2>
        <div class="tools-grid">
            <a href="/room-analysis?project={{ project.id }}" class="tool-card">
                <div class="tool-icon">&#128208;</div>
                <h3>Room Modes</h3>
                <p>Calculate modes for this room</p>
            </a>
            <a href="/magic?project={{ project.id }}" class="tool-card">
                <div class="tool-icon">&#127919;</div>
                <h3>Complete Analysis</h3>
                <p>Full analysis with treatment plan</p>
            </a>
            <a href="/speaker-placement?project={{ project.id }}" class="tool-card">
                <div class="tool-icon">&#128264;</div>
                <h3>Speaker Placement</h3>
                <p>Optimal monitor positions</p>
            </a>
            <a href="/treatment-plan?project={{ project.id }}" class="tool-card">
                <div class="tool-icon">&#128295;</div>
                <h3>Treatment Plan</h3>
                <p>Generate treatment recommendations</p>
            </a>
            <a href="/porous-absorber" class="tool-card">
                <div class="tool-icon">&#128200;</div>
                <h3>Porous Absorber</h3>
                <p>Calculate absorption coefficients</p>
            </a>
        </div>
    </section>
    {% else %}
    <section class="section">
        <div class="empty-state">
            <p>No room geometry defined. Add dimensions to start analyzing.</p>
        </div>
    </section>
    {% endif %}

    {% if project.notes %}
    <section class="section">
        <h2>Notes</h2>
        <div class="result-card"><div class="result-content"><pre style="white-space:pre-wrap;">{{ project.notes }}</pre></div></div>
    </section>
    {% endif %}
</main>

<!-- Edit Room Modal -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:var(--bg-card); padding:2rem; border-radius:var(--radius-lg); max-width:500px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
        <h2 style="margin-bottom:1.5rem;">Edit Room Dimensions</h2>
        <form id="editForm">
            <div class="form-group">
                <label>Room Name</label>
                <input type="text" id="edit-name" value="{{ project.name }}" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="edit-description" value="{{ project.description }}">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Length (m)</label>
                    <input type="number" id="edit-length" step="0.01" value="{{ project.geometry.length if project.geometry else '' }}" required>
                </div>
                <div class="form-group">
                    <label>Width (m)</label>
                    <input type="number" id="edit-width" step="0.01" value="{{ project.geometry.width if project.geometry else '' }}" required>
                </div>
                <div class="form-group">
                    <label>Height (m)</label>
                    <input type="number" id="edit-height" step="0.01" value="{{ project.geometry.height if project.geometry else '' }}" required>
                </div>
            </div>
            <div class="form-group">
                <label>Room Type</label>
                <select id="edit-room-type">
                    <option value="recording_studio" {% if project.room_type == 'recording_studio' %}selected{% endif %}>Recording Studio</option>
                    <option value="mixing_room" {% if project.room_type == 'mixing_room' %}selected{% endif %}>Mixing Room</option>
                    <option value="mastering_room" {% if project.room_type == 'mastering_room' %}selected{% endif %}>Mastering Room</option>
                    <option value="listening_room" {% if project.room_type == 'listening_room' %}selected{% endif %}>Listening Room</option>
                    <option value="live_room" {% if project.room_type == 'live_room' %}selected{% endif %}>Live Room</option>
                    <option value="home_theater" {% if project.room_type == 'home_theater' %}selected{% endif %}>Home Theater</option>
                    <option value="other" {% if project.room_type == 'other' %}selected{% endif %}>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="edit-notes" rows="3" style="width:100%; padding:0.6rem; background:var(--bg-input); color:var(--text-primary); border:2px solid var(--border); border-radius:var(--radius); font-family:var(--font);">{{ project.notes }}</textarea>
            </div>
            <div style="display:flex; gap:0.75rem; margin-top:1.5rem;">
                <button type="submit" class="btn-primary" style="flex:1;">Save Changes</button>
                <button type="button" class="btn-secondary" onclick="hideEditModal()" style="flex:1; background:var(--bg-input); border:2px solid var(--border);">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function deleteProject(id) {
    if (!confirm('Delete this project?')) return;
    try {
        await fetch('/api/projects/' + id, {method: 'DELETE'});
        window.location.href = '/projects';
    } catch(e) { alert('Error deleting project'); }
}

function showEditModal() {
    const modal = document.getElementById('editModal');
    modal.style.display = 'flex';
}

function hideEditModal() {
    const modal = document.getElementById('editModal');
    modal.style.display = 'none';
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        name: document.getElementById('edit-name').value,
        description: document.getElementById('edit-description').value,
        room_type: document.getElementById('edit-room-type').value,
        notes: document.getElementById('edit-notes').value,
        geometry: {
            length: parseFloat(document.getElementById('edit-length').value),
            width: parseFloat(document.getElementById('edit-width').value),
            height: parseFloat(document.getElementById('edit-height').value)
        }
    };
    
    try {
        const resp = await fetch('/api/projects/{{ project.id }}', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await resp.json();
        
        if (result.success) {
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch(err) {
        console.error(err);
        alert('Error updating project');
    }
});

document.getElementById('editModal').addEventListener('click', (e) => {
    if (e.target.id === 'editModal') {
        hideEditModal();
    }
});
</script>
{% endblock %}