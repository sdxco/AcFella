{% extends "base.html" %}
{% block title %}AcFella - Dashboard{% endblock %}
{% block content %}
<main class="container" style="padding-top:2rem;">
    <div class="hero-compact">
        <h1>AcFella Dashboard</h1>
        <p class="hero-subtitle">Professional acoustic analysis & treatment planning</p>
    </div>

    <!-- Projects Section -->
    <section class="section">
        <div class="section-header">
            <h2>Your Projects</h2>
            <button class="btn-primary btn-sm" onclick="showNewProjectModal()">+ New Project</button>
        </div>
        <div class="projects-grid">
            {% for p in projects %}
            <div class="project-card" onclick="window.location='/project/{{p.id}}'">
                <div class="project-card-header">
                    <h3>{{ p.name }}</h3>
                    <span class="badge">{{ p.room_type | replace('_', ' ') | title }}</span>
                </div>
                <p class="text-muted">{{ p.description }}</p>
                {% if p.volume %}
                <p class="project-meta">Volume: {{ "%.1f"|format(p.volume) }} m&sup3;</p>
                {% endif %}
                <div class="project-tags">
                    {% for tag in p.tags %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            <div class="project-card project-card-new" onclick="showNewProjectModal()">
                <div style="text-align:center;padding:2rem;">
                    <div style="font-size:3rem;margin-bottom:1rem;">+</div>
                    <p>Create New Project</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Tools Section -->
    <section class="section">
        <h2>Tools</h2>
        <div class="tools-grid">
            <a href="/room-analysis" class="tool-card">
                <div class="tool-icon">&#128208;</div>
                <h3>Room Modes</h3>
                <p>Calculate axial, tangential & oblique modes. Bonello analysis, optimal ratios.</p>
            </a>
            <a href="/porous-absorber" class="tool-card">
                <div class="tool-icon">&#128200;</div>
                <h3>Porous Absorber</h3>
                <p>Delany-Bazley & Miki models. Absorption coefficient vs frequency with air gap.</p>
            </a>
            <a href="/magic" class="tool-card">
                <div class="tool-icon">&#127919;</div>
                <h3>Complete Analysis</h3>
                <p>Full room analysis: modes, treatment plan, speaker placement, DIY plans.</p>
            </a>
            <a href="/treatment-plan" class="tool-card">
                <div class="tool-icon">&#128295;</div>
                <h3>Treatment Plan</h3>
                <p>Generate treatment recommendations with bill of materials.</p>
            </a>
            <a href="/speaker-placement" class="tool-card">
                <div class="tool-icon">&#128264;</div>
                <h3>Speaker Placement</h3>
                <p>Optimal monitor & listener positions using the 38% rule and SBIR analysis.</p>
            </a>
            <a href="/diy-calculator" class="tool-card">
                <div class="tool-icon">&#128736;</div>
                <h3>DIY Calculator</h3>
                <p>Build guides for broadband absorbers, bass traps, QRD diffusers, Helmholtz resonators.</p>
            </a>
            <a href="/hybrid-panel-simple" class="tool-card">
                <div class="tool-icon">&#10024;</div>
                <h3>Smart Panel Builder</h3>
                <p>Hybrid absorber/reflector panels with MLS patterns.</p>
            </a>
        </div>
    </section>
</main>

<!-- New Project Modal -->
<div id="new-project-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Project</h2>
            <button class="modal-close" onclick="hideModal('new-project-modal')">&times;</button>
        </div>
        <form id="new-project-form" onsubmit="createProject(event)">
            <div class="form-group">
                <label for="proj-name">Project Name *</label>
                <input type="text" id="proj-name" required placeholder="My Studio">
            </div>
            <div class="form-group">
                <label for="proj-desc">Description</label>
                <input type="text" id="proj-desc" placeholder="Mixing room in basement">
            </div>
            <div class="form-group">
                <label for="proj-type">Room Type</label>
                <select id="proj-type">
                    <option value="mixing_mastering">Mixing & Mastering</option>
                    <option value="music_production">Music Production</option>
                    <option value="vocal_recording">Vocal Recording</option>
                    <option value="live_recording">Live Recording</option>
                    <option value="podcast_voiceover">Podcast / Voiceover</option>
                    <option value="home_theater">Home Theater</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Length (m)</label><input type="number" id="proj-length" step="0.01" placeholder="4.2"></div>
                <div class="form-group"><label>Width (m)</label><input type="number" id="proj-width" step="0.01" placeholder="2.8"></div>
                <div class="form-group"><label>Height (m)</label><input type="number" id="proj-height" step="0.01" placeholder="2.4"></div>
            </div>
            <button type="submit" class="btn-primary" style="width:100%">Create Project</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showNewProjectModal() {
    document.getElementById('new-project-modal').classList.remove('hidden');
}
function hideModal(id) {
    document.getElementById(id).classList.add('hidden');
}
async function createProject(e) {
    e.preventDefault();
    const length = parseFloat(document.getElementById('proj-length').value) || 0;
    const width = parseFloat(document.getElementById('proj-width').value) || 0;
    const height = parseFloat(document.getElementById('proj-height').value) || 0;
    const body = {
        name: document.getElementById('proj-name').value,
        description: document.getElementById('proj-desc').value,
        room_type: document.getElementById('proj-type').value,
        geometry: length > 0 ? {length, width, height, volume: Math.round(length*width*height*100)/100} : null,
    };
    try {
        const resp = await fetch('/api/projects', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const data = await resp.json();
        if (data.success) {
            window.location.href = '/project/' + data.project.id;
        } else {
            alert('Error: ' + data.error);
        }
    } catch(err) { alert('Error creating project'); }
}
document.querySelectorAll('.modal').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) hideModal(m.id); });
});
</script>
{% endblock %}