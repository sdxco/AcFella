{% extends "base.html" %}
{% block title %}Treatment Plan - AcFella{% endblock %}
{% block content %}
<main class="container" style="padding-top:2rem;">
    <h1>Treatment Plan Generator</h1>
    <p class="text-muted">Generate specific recommendations for bass traps, absorbers, and diffusers.</p>

    <div class="calculator-layout">
        <div class="calc-inputs">
            <div class="result-card">
                <h3>Room Parameters</h3>
                <form id="tp-form" onsubmit="genTreatment(event)">
                    {% if project %}<div class="project-badge">Project: {{ project.name }}</div>{% endif %}
                    <div class="form-row">
                        <div class="form-group"><label>Length</label><input type="number" id="tp-length" step="0.01" value="{{ project.geometry.length if project and project.geometry else '4.20' }}" required></div>
                        <div class="form-group"><label>Width</label><input type="number" id="tp-width" step="0.01" value="{{ project.geometry.width if project and project.geometry else '2.83' }}" required></div>
                        <div class="form-group"><label>Height</label><input type="number" id="tp-height" step="0.01" value="{{ project.geometry.height if project and project.geometry else '2.41' }}" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit</label>
                            <select id="tp-unit"><option value="metric">Meters</option><option value="imperial">Feet</option></select>
                        </div>
                        <div class="form-group">
                            <label>Room Type</label>
                            <select id="tp-type">
                                <option value="mixing_mastering">Mixing/Mastering</option>
                                <option value="music_production">Music Production</option>
                                <option value="vocal_recording">Vocal Recording</option>
                                <option value="live_recording">Live Recording</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%">Generate Plan</button>
                </form>
                {% if projects %}
                <div class="form-group" style="margin-top:1rem;">
                    <label>Load from project:</label>
                    <select onchange="if(this.value)window.location='/treatment-plan?project='+this.value">
                        <option value="">Select project...</option>
                        {% for p in projects %}<option value="{{p.id}}" {% if project and p.id == project.id %}selected{% endif %}>{{p.name}}</option>{% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="calc-results" id="tp-results" style="display:none;">
            <div class="result-card"><h3>Treatment Items</h3><div id="tp-items" class="result-content"></div></div>
            <div class="result-card"><h3>Bill of Materials</h3><div id="tp-bom" class="result-content"></div></div>
            <div class="result-card"><h3>Notes</h3><div id="tp-notes" class="result-content"></div></div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
async function genTreatment(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = 'Generating...'; btn.disabled = true;
    try {
        const resp = await fetch('/api/generate-treatment-plan', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                length: parseFloat(document.getElementById('tp-length').value),
                width: parseFloat(document.getElementById('tp-width').value),
                height: parseFloat(document.getElementById('tp-height').value),
                unit: document.getElementById('tp-unit').value,
                room_type: document.getElementById('tp-type').value,
            })
        });
        const data = await resp.json();
        if (!data.success) { alert('Error: ' + data.error); return; }
        document.getElementById('tp-results').style.display = '';
        const plan = data.treatment_plan;
        document.getElementById('tp-items').innerHTML = plan.items.map((item, i) => `
            <div class="treatment-item priority-${item.priority || 3}">
                <h4>#${i+1} - ${item.treatment_type || item.type || 'Treatment'}</h4>
                <p>${JSON.stringify(item.dimensions || {})}</p>
                <p><strong>Location:</strong> ${item.location || 'N/A'}</p>
                <p><strong>Priority:</strong> ${item.priority || 'Medium'}</p>
            </div>
        `).join('');
        document.getElementById('tp-bom').innerHTML = '<table class="data-table"><tr><th>Material</th><th>Count</th><th>Notes</th></tr>' +
            Object.entries(plan.bill_of_materials || {}).map(([k,v]) => `<tr><td>${v.material||k}</td><td>${v.count||v.quantity||''}</td><td>${v.total_area ? v.total_area.toFixed(2)+' m2' : ''}</td></tr>`).join('') + '</table>';
        document.getElementById('tp-notes').innerHTML = (plan.notes||[]).map(n => `<p>${n}</p>`).join('') || '<p>No additional notes.</p>';
    } catch(err) { console.error(err); alert('Error generating plan'); }
    finally { btn.textContent = 'Generate Plan'; btn.disabled = false; }
}
</script>
{% endblock %}