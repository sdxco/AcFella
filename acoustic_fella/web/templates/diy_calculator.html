{% extends "base.html" %}
{% block title %}DIY Panel Calculator - AcFella{% endblock %}
{% block content %}
<main class="container" style="padding-top:2rem;">
    <h1>DIY Panel Calculator</h1>
    <p class="text-muted">Construction specs for broadband absorbers, bass traps, Helmholtz resonators, QRD diffusers.</p>

    <div class="calculator-layout">
        <div class="calc-inputs">
            <div class="result-card">
                <h3>Panel Design</h3>
                <form id="diy-form" onsubmit="designPanel(event)">
                    <div class="form-group">
                        <label>Panel Type</label>
                        <select id="diy-type" onchange="updateDiyFields()">
                            <option value="broadband_absorber">Broadband Absorber</option>
                            <option value="corner_bass_trap">Corner Bass Trap</option>
                            <option value="helmholtz_resonator">Helmholtz Resonator</option>
                            <option value="qrd_diffuser">QRD Diffuser</option>
                            <option value="membrane_absorber">Membrane Absorber</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Width (m)</label><input type="number" id="diy-width" step="0.01" value="0.6"></div>
                        <div class="form-group"><label>Height (m)</label><input type="number" id="diy-height" step="0.01" value="1.2"></div>
                    </div>
                    <div class="form-group">
                        <label>Target Frequency (Hz)</label>
                        <input type="number" id="diy-freq" value="250" min="20" max="2000">
                    </div>
                    <div class="form-group" id="diy-prime-group" style="display:none;">
                        <label>Prime Number (QRD)</label>
                        <select id="diy-prime"><option value="5">5</option><option value="7" selected>7</option><option value="11">11</option><option value="13">13</option><option value="17">17</option></select>
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%">Design Panel</button>
                </form>
            </div>
        </div>
        <div class="calc-results" id="diy-results" style="display:none;">
            <div class="result-card"><h3>Panel Specifications</h3><div id="diy-specs" class="result-content"></div></div>
            <div class="result-card"><h3>Absorption Coefficients</h3><div id="diy-absorption" class="result-content"></div></div>
            <div class="result-card"><h3>Materials List</h3><div id="diy-materials" class="result-content"></div></div>
            <div class="result-card"><h3>Construction Steps</h3><div id="diy-steps" class="result-content"></div></div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
function updateDiyFields() {
    const type = document.getElementById('diy-type').value;
    document.getElementById('diy-prime-group').style.display = type === 'qrd_diffuser' ? '' : 'none';
}
async function designPanel(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = 'Designing...'; btn.disabled = true;
    const type = document.getElementById('diy-type').value;
    const body = {
        panel_type: type,
        width: parseFloat(document.getElementById('diy-width').value),
        height: parseFloat(document.getElementById('diy-height').value),
        target_frequency: parseFloat(document.getElementById('diy-freq').value),
        unit: 'metric',
    };
    if (type === 'qrd_diffuser') body.prime_number = parseInt(document.getElementById('diy-prime').value);
    try {
        const resp = await fetch('/api/design-panel', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (!data.success) { alert('Error: ' + data.error); return; }
        document.getElementById('diy-results').style.display = '';
        const p = data.panel;
        document.getElementById('diy-specs').innerHTML = `
            <p><strong>Type:</strong> ${p.type}</p>
            <p><strong>Dimensions:</strong> ${p.dimensions.width}mm x ${p.dimensions.height}mm x ${p.dimensions.depth}mm</p>
            <p><strong>Air Gap:</strong> ${p.dimensions.air_gap}mm</p>
            <p><strong>Material:</strong> ${p.materials.absorber}</p>
            <p><strong>Frame:</strong> ${p.materials.frame}</p>
            <p><strong>Facing:</strong> ${p.materials.facing}</p>
        `;
        if (p.absorption_coefficients) {
            let html = '<table class="data-table"><tr><th>Frequency</th><th>Coefficient</th></tr>';
            for (const [freq, val] of Object.entries(p.absorption_coefficients).sort((a,b)=>parseInt(a[0])-parseInt(b[0]))) {
                const pct = (val * 100).toFixed(0);
                html += `<tr><td>${freq} Hz</td><td><div class="bar-container"><div class="bar-fill" style="width:${pct}%"></div></div> ${val.toFixed(2)}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('diy-absorption').innerHTML = html;
        }
        if (p.materials_list) {
            document.getElementById('diy-materials').innerHTML = '<table class="data-table"><tr><th>Item</th><th>Quantity</th><th>Notes</th></tr>' +
                p.materials_list.map(m => `<tr><td>${m.item}</td><td>${m.quantity}</td><td>${m.notes||''}</td></tr>`).join('') + '</table>';
        }
        if (p.construction_steps) {
            document.getElementById('diy-steps').innerHTML = '<ol>' +
                p.construction_steps.map(s => `<li>${s}</li>`).join('') + '</ol>';
        }
    } catch(err) { console.error(err); alert('Error designing panel'); }
    finally { btn.textContent = 'Design Panel'; btn.disabled = false; }
}
</script>
{% endblock %}