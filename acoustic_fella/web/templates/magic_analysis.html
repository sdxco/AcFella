{% extends "base.html" %}
{% block title %}Complete Analysis - AcFella{% endblock %}
{% block content %}
<main class="container" style="padding-top:2rem;">
    <h1>Complete Room Analysis</h1>
    <p class="text-muted">One comprehensive analysis: room modes, treatment plan, speaker placement, and DIY panel specs.</p>

    <div class="result-card">
        <form id="magic-form" onsubmit="runMagic(event)" enctype="multipart/form-data">
            {% if project %}<div class="project-badge">Project: {{ project.name }}</div>{% endif %}
            <div class="form-row">
                <div class="form-group"><label>Length</label><input type="number" name="length" step="0.01" value="{{ project.geometry.length if project and project.geometry else '4.20' }}" required></div>
                <div class="form-group"><label>Width</label><input type="number" name="width" step="0.01" value="{{ project.geometry.width if project and project.geometry else '2.83' }}" required></div>
                <div class="form-group"><label>Height</label><input type="number" name="height" step="0.01" value="{{ project.geometry.height if project and project.geometry else '2.41' }}" required></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Unit</label><select name="unit"><option value="metric">Meters</option><option value="imperial">Feet</option></select></div>
                <div class="form-group"><label>Room Type</label><select name="room_type"><option value="mixing_mastering">Mixing/Mastering</option><option value="music_production">Music Production</option><option value="vocal_recording">Vocal Recording</option><option value="live_recording">Live Recording</option></select></div>
                <div class="form-group"><label>Speaker Type</label><select name="speaker_type"><option value="nearfield">Nearfield</option><option value="midfield">Midfield</option><option value="main">Main</option></select></div>
            </div>
            <div class="form-group">
                <label>REW Measurement File (optional)</label>
                <input type="file" name="rew_file" accept=".txt,.frd,.mdat,.png,.jpg,.jpeg">
            </div>
            <button type="submit" class="btn-primary" style="width:100%;">Run Complete Analysis</button>
        </form>
        {% if projects %}
        <div class="form-group" style="margin-top:1rem;">
            <label>Load from project:</label>
            <select onchange="if(this.value)window.location='/magic?project='+this.value">
                <option value="">Select project...</option>
                {% for p in projects %}<option value="{{p.id}}" {% if project and p.id == project.id %}selected{% endif %}>{{p.name}}</option>{% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    <div id="magic-results" style="display:none;">
        <div class="results-grid">
            <div class="result-card"><h3>Room Overview</h3><div id="mg-room" class="result-content"></div></div>
            <div class="result-card"><h3>Schroeder & Modes</h3><div id="mg-modes" class="result-content"></div></div>
        </div>
        <div class="result-card"><h3>Mode Distribution</h3><div style="height:300px;"><canvas id="mg-chart"></canvas></div></div>
        <div class="results-grid">
            <div class="result-card"><h3>Speaker Placement</h3><div id="mg-speakers" class="result-content"></div></div>
            <div class="result-card"><h3>Treatment Items</h3><div id="mg-treatment" class="result-content" style="max-height:400px;overflow-y:auto;"></div></div>
        </div>
        <div class="result-card"><h3>DIY Panel Plans</h3><div id="mg-diy" class="result-content"></div></div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
let mgChart = null;
async function runMagic(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = 'Analyzing...'; btn.disabled = true;
    try {
        const formData = new FormData(e.target);
        const resp = await fetch('/api/magic-analysis', {method:'POST', body:formData});
        const d = await resp.json();
        if (!d.success) { alert('Error: ' + (d.error||'Unknown')); return; }
        document.getElementById('magic-results').style.display = '';

        // Room overview
        document.getElementById('mg-room').innerHTML = `
            <p><strong>Volume:</strong> ${d.room.volume} m&sup3;</p>
            <p><strong>Schroeder Freq:</strong> ${d.room.schroeder_frequency} Hz</p>
            <p><strong>Target RT60:</strong> ${d.room.target_t60} ms</p>
            <p><strong>Ratios:</strong> ${d.room.ratios.join(' : ')} (${d.room.ratio_quality})</p>
        `;

        // Modes
        document.getElementById('mg-modes').innerHTML = `
            <p><strong>Total Modes (< 300Hz):</strong> ${d.modes.modes.length}</p>
            <p><strong>Bonello:</strong> <span class="${d.modes.bonello_pass?'good':'bad'}">${d.modes.bonello_pass?'PASSES':'FAILS'}</span></p>
            <p>${d.modes.bonello_notes}</p>
        `;

        // Modes chart
        if (mgChart) mgChart.destroy();
        const modes = d.modes.modes.slice(0, 30);
        const ctx = document.getElementById('mg-chart').getContext('2d');
        mgChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: modes.map(m => m.frequency + 'Hz'),
                datasets: [{label:'Modes', data: modes.map(m=>m.frequency),
                    backgroundColor: modes.map(m => m.type==='Axial'?'#ef4444':m.type==='Tangential'?'#f59e0b':'#22c55e'), borderRadius:2}]
            },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,title:{display:true,text:'Hz'}}} }
        });

        // Speaker placement
        const sp = d.speaker_placement;
        document.getElementById('mg-speakers').innerHTML = '<pre style="white-space:pre-wrap;font-size:0.85em;">' + JSON.stringify(sp, null, 2) + '</pre>';

        // Treatment
        const items = d.treatment_plan.items || [];
        document.getElementById('mg-treatment').innerHTML = items.map((it,i) => `
            <div class="treatment-item priority-${it.priority||3}">
                <h4>#${i+1} ${it.name||it.treatment_type||''}</h4>
                <p>${it.description||''}</p>
                <p><strong>Placement:</strong> ${it.placement||''}</p>
                <p><strong>Dimensions:</strong> ${it.dimensions||''}</p>
            </div>
        `).join('') || '<p>No recommendations.</p>';

        // DIY
        const diyPanels = d.diy_panels || [];
        document.getElementById('mg-diy').innerHTML = diyPanels.map(p => `
            <div class="diy-panel-card">
                <h4>${(p.type||'').replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</h4>
                <p>${JSON.stringify(p.specifications||{})}</p>
            </div>
        `).join('') || '<p>No DIY plans generated.</p>';
    } catch(err) { console.error(err); alert('Analysis error: ' + err.message); }
    finally { btn.textContent = 'Run Complete Analysis'; btn.disabled = false; }
}
</script>
{% endblock %}