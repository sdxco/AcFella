{% extends "base.html" %}
{% block title %}Speaker Placement - AcFella{% endblock %}
{% block content %}
<main class="container" style="padding-top:2rem;">
    <h1>Speaker & Listener Placement</h1>
    <p class="text-muted">Optimal monitor and listening positions using the 38% rule, SBIR analysis, and stereo triangle.</p>

    <div class="calculator-layout">
        <div class="calc-inputs">
            <div class="result-card">
                <h3>Room Dimensions</h3>
                <form id="sp-form" onsubmit="calcSpeakers(event)">
                    {% if project %}<div class="project-badge">Project: {{ project.name }}</div>{% endif %}
                    <div class="form-row">
                        <div class="form-group"><label>Length</label><input type="number" id="sp-length" step="0.01" value="{{ project.geometry.length if project and project.geometry else '4.20' }}" required></div>
                        <div class="form-group"><label>Width</label><input type="number" id="sp-width" step="0.01" value="{{ project.geometry.width if project and project.geometry else '2.83' }}" required></div>
                        <div class="form-group"><label>Height</label><input type="number" id="sp-height" step="0.01" value="{{ project.geometry.height if project and project.geometry else '2.41' }}" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit</label>
                            <select id="sp-unit"><option value="metric">Meters</option><option value="imperial">Feet</option></select>
                        </div>
                        <div class="form-group">
                            <label>Speaker Type</label>
                            <select id="sp-type"><option value="nearfield">Nearfield</option><option value="midfield">Midfield</option><option value="main">Main</option></select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="width:100%">Calculate Placement</button>
                </form>
                {% if projects %}
                <div class="form-group" style="margin-top:1rem;">
                    <label>Load from project:</label>
                    <select onchange="if(this.value)window.location='/speaker-placement?project='+this.value">
                        <option value="">Select project...</option>
                        {% for p in projects %}<option value="{{p.id}}" {% if project and p.id == project.id %}selected{% endif %}>{{p.name}}</option>{% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="calc-results" id="sp-results" style="display:none;">
            <div class="result-card"><h3>Placement Results</h3><div id="sp-data" class="result-content"></div></div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
async function calcSpeakers(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = 'Calculating...'; btn.disabled = true;
    try {
        const resp = await fetch('/api/speaker-placement', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                length: parseFloat(document.getElementById('sp-length').value),
                width: parseFloat(document.getElementById('sp-width').value),
                height: parseFloat(document.getElementById('sp-height').value),
                unit: document.getElementById('sp-unit').value,
                speaker_type: document.getElementById('sp-type').value,
            })
        });
        const data = await resp.json();
        if (!data.success) { alert('Error: ' + data.error); return; }
        document.getElementById('sp-results').style.display = '';
        const p = data.placement;
        document.getElementById('sp-data').innerHTML = '<pre style="white-space:pre-wrap;">' + JSON.stringify(p, null, 2) + '</pre>';
    } catch(err) { console.error(err); alert('Error'); }
    finally { btn.textContent = 'Calculate Placement'; btn.disabled = false; }
}
</script>
{% endblock %}